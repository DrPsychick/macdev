---

- name: Check for homebrew
  stat: path=/usr/local/bin/brew
  register: homebrew

- name: Homebrew needs manual installation
  debug: msg='Install homebrew manually (https://brew.sh) /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"'
  when: homebrew.stat.exists == false
  failed_when: homebrew.stat.exists == false

- name: Setup brew for multiple users
  shell: (cd /usr/local; chmod +a "group:{{ user_group }} allow list,add_file,search,add_subdirectory,delete_child,chown,readattr,writeattr,readextattr,writeextattr,readsecurity,file_inherit,directory_inherit" Homebrew Caskroom Cellar bin && chgrp -vR {{ user_group }} Homebrew Caskroom Cellar bin && chmod -R g+rwX Homebrew Caskroom Cellar bin)
  args:
    executable: /bin/bash
  register: brew_chmod
  failed_when: brew_chmod.rc == 1
  changed_when: false
  when: brew_multiuser|bool == true

- name: Update homebrew
  homebrew:
    update_homebrew: yes

- name: Upgrade homebrew packages
  homebrew:
    upgrade_all: yes

- name: Install brew packages
  homebrew:
    name: "{{ item.name }}"
    state: latest
  with_items: "{{ brew_packages }}"
  when: brew_packages[0] is defined

- name: Upgrade homebrew casks
  homebrew_cask:
    upgrade_all: yes

- name: Install brew cask packages
  homebrew_cask:
    name: "{{ item.name }}"
  with_items: "{{ brew_cask_packages }}"
  when: brew_cask_packages[0] is defined

